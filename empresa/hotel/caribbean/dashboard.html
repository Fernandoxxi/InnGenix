<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Hotel Caribbean</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <style>
      @keyframes blink {
        50% { background-color: #dc2626; color: #fff; }
      }
      .warning-blink {
        animation: blink 1s infinite;
      }
      .vencido {
        border: 2px solid #dc2626 !important;
        box-shadow: 0 0 10px #dc2626;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .animate-fadeIn {
        animation: fadeIn 0.3s ease-out;
      }
      .custom-select {
        position: relative;
        width: 100%;
        font-size: 14px;
      }
      .custom-select .selected {
        border: 1px solid #d1d5db;
        border-radius: 6px;
        padding: 8px 12px;
        background: #fff;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .custom-select .selected span {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .custom-select .selected img {
        width: 20px;
        height: 14px;
      }
      .custom-select .options {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        background: #fff;
        display: none;
        max-height: 200px;
        overflow-y: auto;
        z-index: 100;
      }
      .custom-select.open .options {
        display: block;
      }
      .custom-select .option {
        padding: 8px 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }
      .custom-select .option img {
        width: 20px;
        height: 14px;
      }
      .custom-select .option:hover {
        background: #f1f5f9;
      }

      .benefit-card {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 13px;
        color: #374151;
        transition: all 0.2s;
        cursor: default;
      }
      .benefit-card i {
        font-size: 16px;
        color: var(--primary);
      }
      .benefit-card:hover {
        background: #eef2ff;
        border-color: #c7d2fe;
        transform: translateY(-2px);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      }

      :root {
        --navy: #1f2b46; /* Disponible */
        --teal: #16a085; /* Limpieza */
        --amber: #f59e0b; /* Ocupado */
        --stroke: #d9dde5;
        --primary: #2563eb;
        --primary-dark: #1d4ed8;
        --success: #059669;
        --success-dark: #047857;
        --accent: #7c3aed;
      }
      body {
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto,
          Arial;
      }

      .main-wrap {
        display: flex;
        align-items: flex-start;
        padding: 10px 12px 0;
        gap: 10px;
      }
      #rooms {
        flex: 1;
      }
      aside {
        width: 280px;
      }

      .floor-row {
        display: grid;
        grid-template-columns: 64px 1fr;
        gap: 0.5rem;
        align-items: start;
        margin-bottom: 0.6rem;
      }
      .floor-label {
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        color: #475569;
        font-size: 12px;
      }
      .floor-grid {
        display: grid;
        gap: 0.5rem;
        grid-template-columns: repeat(10, minmax(90px, 1fr));
      }
      .room-card {
        border: 1px solid var(--stroke);
        border-radius: 6px;
        background: #fff;
        height: 92px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transition: 0.15s;
        cursor: pointer;
      }
      .room-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.06);
      }
      .room-center {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }
      .room-num {
        font-weight: 900;
        font-size: 19px;
        color: #111827;
      }
      .room-name {
        font-size: 11px;
        font-weight: 800;
        color: #374151;
      }
      .badge-dispo {
        background: var(--navy);
        color: #fff;
        font-weight: 900;
        font-size: 11px;
        height: 22px;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }
      .clean-time {
        font-size: 10px;
        color: #6b7280;
        font-weight: 800;
      }
      .badge-clean {
        background: var(--teal);
        color: #fff;
        font-weight: 900;
        font-size: 12px;
        height: 26px;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }
      .busy-bar {
        width: 100%;
        height: 24px;
        display: flex;
      }
      .busy-left {
        flex: 2;
        background: var(--amber);
        color: #fff;
        font-weight: 900;
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: width 0.3s;
      }
      .busy-right {
        flex: 1;
        background: #fff;
        color: #475569;
        font-weight: 900;
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .hdr-btn {
        height: 34px;
        padding: 0 10px;
        border-radius: 0.5rem;
        font-weight: 800;
        font-size: 13px;
      }
      .dropdown-menu {
        display: none;
      }
      .dropdown.open .dropdown-menu {
        display: block;
      }
      .tab-btn {
        padding: 0.5rem 0;
        font-weight: 900;
        color: #64748b;
        border-bottom: 2px solid transparent;
      }
      .tab-btn.active {
        color: #0ea5e9;
        border-bottom-color: #0ea5e9;
      }
      .kpi-circle {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 13px;
        color: white;
      }

      /* Modal */
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 50;
      }
      .modal.show {
        display: flex;
      }

      .modal-content {
        width: 95%;
        max-width: 1300px;
        height: 90vh;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
      }

      .modal-header {
        background: linear-gradient(135deg, #1f2b46 0%, #2d3e63 100%);
        color: white;
        padding: 15px 20px;
        border-bottom: 1px solid #2d3e63;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 25px;
        background: #f8fafc;
      }

      .modal-column {
        display: flex;
        flex-direction: column;
        gap: 20px;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }

      .section-title {
        font-weight: 700;
        margin-bottom: 15px;
        padding-bottom: 10px;
        color: #1f2b46;
        font-size: 16px;
        border-bottom: 2px solid #e2e8f0;
        position: relative;
      }

      .section-title:after {
        content: "";
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 40px;
        height: 2px;
        background: var(--primary);
      }

      .form-group {
        margin-bottom: 15px;
      }
      .form-label {
        display: block;
        font-size: 13px;
        margin-bottom: 6px;
        font-weight: 600;
        color: #374151;
      }
      .form-input,
      .form-select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.2s;
        background: #f9fafb;
      }
      .form-input:focus,
      .form-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
        background: white;
      }
      .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      .radio-group {
        display: flex;
        gap: 20px;
        margin-bottom: 10px;
      }
      input[type="radio"] {
        accent-color: var(--primary);
      }

      .benefits-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
        margin: 10px 0;
      }
      .benefit-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: #f9fafb;
        transition: 0.2s;
      }
      .benefit-item:hover {
        background: #f1f5f9;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      }
      .benefit-icon {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        color: #fff;
        border-radius: 8px;
        flex-shrink: 0;
      }
      .tabs {
        display: flex;
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 15px;
      }
      .tab {
        padding: 10px 16px;
        cursor: pointer;
        font-size: 13px;
        background: #f9fafb;
        border: 1px solid transparent;
        border-bottom: none;
        margin-right: 4px;
        border-top-left-radius: 6px;
        border-top-right-radius: 6px;
        transition: 0.2s;
        color: #6b7280;
        font-weight: 500;
      }
      .tab.active {
        background: white;
        border-color: #e5e7eb;
        font-weight: 600;
        color: var(--primary);
        position: relative;
      }
      .tab.active:after {
        content: "";
        position: absolute;
        bottom: -1px;
        left: 0;
        width: 100%;
        height: 2px;
        background: white;
      }

      .table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        border-radius: 8px;
        overflow: hidden;
      }
      .table th,
      .table td {
        border: 1px solid #e5e7eb;
        padding: 10px 12px;
        text-align: left;
      }
      .table th {
        background: #f1f5f9;
        font-weight: 600;
        color: #374151;
      }
      .table tr:nth-child(even) {
        background: #f9fafb;
      }
      .table tr:last-child {
        font-weight: 600;
        background: #f1f5f9;
      }

      .payment-section {
        background: #f8fafc;
        padding: 20px;
        border-radius: 8px;
        margin-top: 15px;
        border: 1px solid #e2e8f0;
      }
      .form-grid-3 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
      }

      .btn {
        padding: 12px 16px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        border: none;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        color: white;
      }
      .btn-primary:hover {
        background: linear-gradient(
          135deg,
          var(--primary-dark) 0%,
          #1e40af 100%
        );
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);
      }
      .btn-success {
        background: linear-gradient(
          135deg,
          var(--success) 0%,
          var(--success-dark) 100%
        );
        color: white;
      }
      .btn-success:hover {
        background: linear-gradient(
          135deg,
          var(--success-dark) 0%,
          #065f46 100%
        );
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(5, 150, 105, 0.25);
      }
      .close-btn {
        background: #ef4444;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 600;
        transition: 0.2s;
      }
      .close-btn:hover {
        background: #dc2626;
        transform: scale(1.05);
      }

      textarea.form-input {
        min-height: 80px;
        resize: vertical;
      }

      /* Lateral reservas */
      .reserva-card {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 10px 12px;
        background: #f9fafb;
        transition: 0.2s;
      }
      .reserva-card:hover {
        background: #fff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
      }
      .reserva-nombre {
        font-weight: 700;
        color: #111827;
        font-size: 14px;
      }
      .reserva-monto {
        font-weight: 600;
        color: #059669;
        font-size: 13px;
      }
      .reserva-detalle {
        background: var(--primary);
        color: #fff;
        font-size: 12px;
        padding: 3px 8px;
        border-radius: 6px;
        margin-top: 6px;
        display: inline-block;
      }
    </style>
  </head>
  <body class="bg-white text-slate-900">
    <!-- HEADER -->
    <header
      class="h-16 bg-slate-900 text-white px-3 md:px-6 flex items-center justify-between shadow"
    >
      <nav class="hidden sm:flex items-center gap-4 text-[13px]">
        <a
          href="dashboard.html"
          class="hover:text-cyan-400 flex items-center gap-2"
          ><i class="fa-solid fa-concierge-bell"></i>Recepción</a
        >
        <a
          href="post-venta.html"
          class="hover:text-cyan-400 flex items-center gap-2"
          ><i class="fa-solid fa-handshake"></i>Post Venta</a
        >
        <a
          href="inventario.html"
          class="hover:text-cyan-400 flex items-center gap-2"
          ><i class="fa-solid fa-boxes-stacked"></i>Inventario</a
        >
      </nav>
      <div class="flex items-center gap:2 md:gap-3">
        <button onclick="openReserva()"
          class="hdr-btn bg-emerald-600 text-white hover:bg-emerald-700 flex items-center gap-2"
        >
          <i class="fa-solid fa-calendar-plus"></i>Reserva
        </button>
        <button
          onclick="openCaja()"
          class="hdr-btn bg-amber-500 hover:bg-amber-600 text-white flex items-center gap-2"
        >
          <i class="fa-solid fa-cash-register"></i>Caja 1
        </button>
        <button
          onclick="logout()"
          class="hdr-btn bg-red-600 hover:bg-red-700 text-white flex items-center gap-2"
        >
          <i class="fa-solid fa-right-from-bracket"></i>Salir
        </button>
      </div>
    </header>

    <!-- ENCABEZADO DEL TABLERO -->
    <div class="flex items-center justify-between px-4 py:2 border-b">
      <h2 class="text-lg font-bold text-red-600">HOTEL CARIBBEAN</h2>
      <div class="flex gap:2">
        <div id="kpiOcup" class="kpi-circle" style="background: var(--amber)">
          0
        </div>
        <div id="kpiLimp" class="kpi-circle" style="background: var(--teal)">
          0
        </div>
        <div id="kpiDisp" class="kpi-circle" style="background: var(--navy)">
          0
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main-wrap">
      <section id="rooms"></section>
      <aside class="bg-white border border-slate-200 p-3 overflow-y-auto">
        <div class="flex border-b border-slate-200 mb-2">
          <button
            id="tab-pedidos"
            class="tab-btn active flex-1 text-center"
            onclick="switchTab('pedidos')"
          >
            Pedidos
          </button>
          <button
            id="tab-reservas"
            class="tab-btn flex-1 text-center"
            onclick="switchTab('reservas')"
          >
            Reservas
          </button>
        </div>
        <div id="panel-pedidos" class="space-y-2"></div>
        <div id="panel-reservas" class="space-y-3 hidden">
          <!-- Reservas Futuras -->
        </div>
      </aside>
    </div>

    <!-- MODAL ALQUILER -->
    <div id="modalAlquiler" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="font-bold text-lg">Alquiler Habitación</h2>
          <button onclick="closeAlquiler()" class="close-btn">Cerrar ✖</button>
        </div>
        <div class="modal-body">
          <!-- Columna 1 -->
          <div class="modal-column">
            <h3 class="section-title">1. HUÉSPED</h3>
            <div class="custom-select" id="guestCountry"></div>

            <div class="form-grid">
              <select id="guestDocType" class="form-select">
                <option>DNI</option>
                <option>CE</option>
                <option>Pasaporte</option>
              </select>
              <div class="relative">
                <input
                  id="guestDocNum"
                  class="form-input pr-10"
                  placeholder="N° Documento"
                />
                <button
                  type="button"
                  class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-blue-600"
                >
                  <i class="fa-solid fa-magnifying-glass"></i>
                </button>
              </div>
            </div>

            <div class="form-grid">
              <input
                id="guestApellido1"
                class="form-input"
                placeholder="Primer Apellido"
              />
              <input
                id="guestApellido2"
                class="form-input"
                placeholder="Segundo Apellido"
              />
            </div>
            <input id="guestNombres" class="form-input" placeholder="Nombres" />
            <div class="form-grid">
              <input id="guestFechaNac" type="date" class="form-input" />
              <select id="guestGenero" class="form-select">
                <option>Masculino</option>
                <option>Femenino</option>
              </select>
            </div>

            <h3 class="section-title">2. ACOMPAÑANTE</h3>
            <div class="custom-select" id="acomCountry"></div>
            <div class="form-grid">
              <select id="acomDocType" class="form-select">
                <option>DNI</option>
                <option>CE</option>
                <option>Pasaporte</option>
              </select>
              <div class="relative">
                <input
                  id="acomDocNum"
                  class="form-input pr-10"
                  placeholder="N° Documento"
                />
                <button
                  type="button"
                  class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-blue-600"
                >
                  <i class="fa-solid fa-magnifying-glass"></i>
                </button>
              </div>
            </div>
            <div class="form-grid">
              <input
                id="acomApellido1"
                class="form-input"
                placeholder="Primer Apellido"
              />
              <input
                id="acomApellido2"
                class="form-input"
                placeholder="Segundo Apellido"
              />
            </div>
            <input id="acomNombres" class="form-input" placeholder="Nombres" />
            <div class="form-grid">
              <input id="acomFechaNac" type="date" class="form-input" />
              <select id="acomGenero" class="form-select">
                <option>Masculino</option>
                <option>Femenino</option>
              </select>
            </div>
          </div>

          <!-- Columna 2 -->
          <div class="modal-column">
            <h3 class="section-title">3. HABITACIÓN</h3>
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label font-bold">Hora de Entrada</label>
                <input id="entradaInfo" class="form-input" readonly />
              </div>
              <div class="form-group">
                <label class="form-label font-bold">Hora de Salida</label>
                <input id="salidaInfo" class="form-input" readonly />
              </div>
            </div>

            <div class="form-grid">
              <div class="form-group relative">
                <label class="form-label font-bold">Duración (horas)</label>
                <input
                  id="duracionHoras"
                  type="number"
                  class="form-input pl-8"
                  min="1"
                  max="72"
                  value="12"
                />
                <i
                  class="fa-solid fa-clock absolute left-2 top-9 text-gray-500"
                ></i>
              </div>
              <div class="form-group">
                <label class="form-label font-bold">Tarifa</label>
                <input
                  id="tarifaInput"
                  type="number"
                  class="form-input"
                  value="50"
                />
              </div>
            </div>
            <div class="form-group">
              <label class="form-label font-bold">Observaciones</label>
              <textarea
                id="observacionesInput"
                class="form-input"
                rows="2"
                placeholder="Observaciones"
              ></textarea>
            </div>

            <h3 class="section-title">BENEFICIOS</h3>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
              <div class="benefit-card">
                <i class="fas fa-tv"></i><span>Smart TV</span>
              </div>
              <div class="benefit-card">
                <i class="fas fa-music"></i><span>Radio Bluetooth</span>
              </div>
              <div class="benefit-card">
                <i class="fas fa-shower"></i><span>Ducha española</span>
              </div>
              <div class="benefit-card">
                <i class="fas fa-bed"></i><span>Cama 2 plazas</span>
              </div>
              <div class="benefit-card">
                <i class="fas fa-wifi"></i><span>Wi-Fi</span>
              </div>
              <div class="benefit-card">
                <i class="fas fa-snowflake"></i><span>Aire acondicionado</span>
              </div>
              <div class="benefit-card">
                <i class="fas fa-lock"></i><span>Caja seguridad</span>
              </div>
            </div>
          </div>

          <!-- Columna 3 -->
          <div class="modal-column">
            <div class="tabs">
              <div class="tab active" data-tab="venta">Realizar Venta</div>
            </div>

            <!-- Venta -->
            <div id="tab-venta" class="tab-content">
              <!-- Buscador -->
              <div class="mb-3">
                <div class="flex items-center gap-2">
                  <input
                    id="searchProduct"
                    class="form-input flex-1"
                    placeholder="BUSCAR PRODUCTO"
                  />
                  <button id="addProductBtn" class="btn btn-primary">
                    <i class="fa-solid fa-plus"></i>
                  </button>
                </div>
                <ul
                  id="productResults"
                  class="border border-gray-200 rounded mt-1 hidden bg-white shadow text-sm"
                ></ul>
              </div>

              <!-- Tabla productos -->
              <table class="table mb-2" id="consumoTable">
                <thead>
                  <tr>
                    <th>Tipo</th>
                    <th>Descripción</th>
                    <th>Cantidad</th>
                    <th>P. Unit</th>
                    <th>Importe</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Aquí se irán agregando los productos -->
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="4" class="text-right font-bold">Total:</td>
                    <td id="totalVenta">0</td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>

              <!-- Datos de comprobante -->
              <div class="flex flex-wrap gap-4 mb-3 text-sm items-center">
                <label
                  ><input type="radio" name="comp" value="boleta" checked />
                  Boleta</label
                >
                <label
                  ><input type="radio" name="comp" value="factura" />
                  Factura</label
                >
                <input
                  id="rucField"
                  class="form-input flex-1 disabled:bg-gray-100 disabled:text-gray-500 disabled:cursor-not-allowed"
                  placeholder="Ingrese RUC"
                  disabled
                />
              </div>

              <!-- Pago -->
              <div class="grid grid-cols-2 gap-2 items-center mb-3">
                <select class="form-select">
                  <option>Efectivo</option>
                  <option>Tarjeta</option>
                  <option>Yape</option>
                </select>
                <input
                  id="recibiField"
                  class="form-input bg-gray-100"
                  readonly
                  disabled
                />
              </div>
              <button id="btnRegistrarVenta" class="btn btn-success w-full">
                <i class="fa-solid fa-check"></i> Registrar Venta
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL OCUPADO -->
    <div id="modalOcupado" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="font-bold text-lg">Habitación Ocupada</h2>
          <button onclick="closeOcupado()" class="close-btn">Cerrar ✖</button>
        </div>
        <div class="modal-body">
          <!-- Columna 1 -->
          <div class="modal-column">
            <h3 class="section-title">1. HUÉSPED</h3>

            <div class="custom-select" id="guestCountryOcupado"></div>

            <div class="form-grid">
              <select class="form-select disabled:cursor-not-allowed" disabled>
                <option>DNI</option>
                <option>CE</option>
                <option>Pasaporte</option>
              </select>
              <div class="relative">
                <input
                  id="docOcupado"
                  class="form-input pr-10 disabled:cursor-not-allowed"
                  placeholder="N° Documento"
                  readonly
                  disabled
                />
                <button
                  type="button"
                  class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400"
                >
                  <i class="fa-solid fa-magnifying-glass"></i>
                </button>
              </div>
            </div>

            <div class="form-grid">
              <input
                id="apellido1Ocupado"
                class="form-input disabled:cursor-not-allowed"
                placeholder="Primer Apellido"
                readonly
                disabled
              />
              <input
                id="apellido2Ocupado"
                class="form-input disabled:cursor-not-allowed"
                placeholder="Segundo Apellido"
                readonly
                disabled
              />
            </div>
            <input
              id="nombresOcupado"
              class="form-input disabled:cursor-not-allowed"
              placeholder="Nombres"
              readonly
              disabled
            />
            <div class="form-grid">
              <input
                id="fechaNacOcupado"
                type="date"
                class="form-input disabled:cursor-not-allowed"
                readonly
                disabled
              />
              <select class="form-select disabled:cursor-not-allowed" disabled>
                <option>Masculino</option>
                <option>Femenino</option>
              </select>
            </div>

            <h3 class="section-title">2. ACOMPAÑANTE</h3>
            <div class="custom-select" id="acomCountryOcupado"></div>
            <div class="form-grid">
              <select class="form-select disabled:cursor-not-allowed" disabled>
                <option>DNI</option>
                <option>CE</option>
                <option>Pasaporte</option>
              </select>
              <div class="relative">
                <input
                  id="docAcomOcupado"
                  class="form-input pr-10 disabled:cursor-not-allowed"
                  placeholder="N° Documento"
                  readonly
                  disabled
                />
                <button
                  type="button"
                  class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400"
                >
                  <i class="fa-solid fa-magnifying-glass"></i>
                </button>
              </div>
            </div>
            <div class="form-grid">
              <input
                id="apellido1AcomOcupado"
                class="form-input disabled:cursor-not-allowed"
                placeholder="Primer Apellido"
                readonly
                disabled
              />
              <input
                id="apellido2AcomOcupado"
                class="form-input disabled:cursor-not-allowed"
                placeholder="Segundo Apellido"
                readonly
                disabled
              />
            </div>
            <input
              id="nombresAcomOcupado"
              class="form-input disabled:cursor-not-allowed"
              placeholder="Nombres"
              readonly
              disabled
            />
            <div class="form-grid">
              <input
                id="fechaNacAcomOcupado"
                class="form-input disabled:cursor-not-allowed"
                readonly
                disabled
              />
              <select class="form-select disabled:cursor-not-allowed" disabled>
                <option>Femenino</option>
              </select>
            </div>
          </div>

          <!-- Columna 2 -->
          <div class="modal-column">
            <h3 class="section-title">3. HABITACIÓN</h3>
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label font-bold">Hora de Entrada</label>
                <input
                  id="entradaInfoOcupado"
                  class="form-input disabled:cursor-not-allowed"
                  readonly
                  disabled
                />
              </div>
              <div class="form-group">
                <label class="form-label font-bold">Hora de Salida</label>
                <input
                  id="salidaInfoOcupado"
                  class="form-input disabled:cursor-not-allowed"
                  readonly
                  disabled
                />
              </div>
            </div>
            <div class="form-grid">
              <div class="form-group relative">
                <label class="form-label font-bold">Duración (horas)</label>
                <input
                  id="duracionOcupado"
                  type="number"
                  class="form-input pl-8 disabled:cursor-not-allowed"
                  readonly
                  disabled
                />
                <i
                  class="fa-solid fa-clock absolute left-2 top-9 text-gray-500"
                ></i>
              </div>
              <div class="form-group">
                <label class="form-label font-bold">Tarifa</label>
                <input
                  id="tarifaOcupado"
                  type="number"
                  class="form-input disabled:cursor-not-allowed"
                  readonly
                  disabled
                />
              </div>
            </div>
            <div class="form-group">
              <label class="form-label font-bold">Observaciones</label>
              <textarea
                id="obsOcupado"
                class="form-input"
                rows="2"
                readonly
              ></textarea>
            </div>

            <h3 class="section-title">BENEFICIOS</h3>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
              <div class="benefit-card">
                <i class="fas fa-tv"></i><span>Smart TV</span>
              </div>
              <div class="benefit-card">
                <i class="fas fa-music"></i><span>Radio Bluetooth</span>
              </div>
              <div class="benefit-card">
                <i class="fas fa-shower"></i><span>Ducha española</span>
              </div>
              <div class="benefit-card">
                <i class="fas fa-bed"></i><span>Cama 2 plazas</span>
              </div>
              <div class="benefit-card">
                <i class="fas fa-wifi"></i><span>Wi-Fi</span>
              </div>
              <div class="benefit-card">
                <i class="fas fa-snowflake"></i><span>Aire acondicionado</span>
              </div>
              <div class="benefit-card">
                <i class="fas fa-lock"></i><span>Caja seguridad</span>
              </div>
            </div>
          </div>

          <!-- Columna 3 -->
          <div class="modal-column">
            <div class="tabs">
              <div class="tab" data-tab="ventaOcupado">Realizar Venta</div>
              <div class="tab active" data-tab="pedido">Realizar Pedido</div>
              <div class="tab" data-tab="incidencia">Incidencias</div>
              <div class="tab" data-tab="visitas">Visitas</div>
            </div>

            <!-- Venta -->
            <div id="tab-ventaOcupado" class="tab-content hidden">
              <!-- Buscador -->
              <div class="mb-3">
                <div class="flex items-center gap-2">
                  <input
                    id="searchProductOcupado"
                    class="form-input flex-1"
                    placeholder="BUSCAR PRODUCTO"
                  />
                  <button id="addProductBtnOcupado" class="btn btn-primary">
                    <i class="fa-solid fa-plus"></i>
                  </button>
                </div>
                <ul
                  id="productResultsOcupado"
                  class="border border-gray-200 rounded mt-1 hidden bg-white shadow text-sm"
                ></ul>
              </div>

              <!-- Tabla productos -->
              <table class="table mb-2" id="consumoTableOcupado">
                <thead>
                  <tr>
                    <th>Tipo</th>
                    <th>Descripción</th>
                    <th>Cantidad</th>
                    <th>P. Unit</th>
                    <th>Importe</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td colspan="4" class="text-right font-bold">Total:</td>
                    <td id="totalVentaOcupado">0</td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>

              <!-- Datos de comprobante -->
              <div class="flex flex-wrap gap-4 mb-3 text-sm items-center">
                <label
                  ><input
                    type="radio"
                    name="compOcupado"
                    value="boleta"
                    checked
                  />
                  Boleta</label
                >
                <label
                  ><input type="radio" name="compOcupado" value="factura" />
                  Factura</label
                >
                <input
                  id="rucFieldOcupado"
                  class="form-input flex-1 disabled:bg-gray-100 disabled:text-gray-500 disabled:cursor-not-allowed"
                  placeholder="Ingrese RUC"
                  disabled
                />
              </div>

              <!-- Pago -->
              <div class="grid grid-cols-2 gap-2 items-center mb-3">
                <select class="form-select">
                  <option>Efectivo</option>
                  <option>Tarjeta</option>
                  <option>Yape</option>
                </select>
                <input
                  id="recibiFieldOcupado"
                  class="form-input bg-gray-100"
                  readonly
                  disabled
                />
              </div>

              <button class="btn btn-success w-full">
                <i class="fa-solid fa-check"></i> Registrar Venta
              </button>
            </div>

            <!-- Pedido -->
            <div id="tab-pedido" class="tab-content hidden">
              <!-- Buscador -->
              <div class="mb-3">
                <div class="flex items-center gap-2">
                  <input
                    id="searchPedido"
                    class="form-input flex-1"
                    placeholder="BUSCAR PRODUCTO"
                  />
                  <button id="addPedidoBtn" class="btn btn-primary">
                    <i class="fa-solid fa-plus"></i>
                  </button>
                </div>
                <ul
                  id="pedidoResults"
                  class="border border-gray-200 rounded mt-1 hidden bg-white shadow text-sm"
                ></ul>
              </div>

              <!-- Tabla -->
              <table class="table mb-2" id="pedidoTable">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th>Cant.</th>
                    <th>P. Unit</th>
                    <th>Importe</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="5" class="text-center text-gray-500">
                      Sin productos
                    </td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="3" class="text-right font-bold">Total:</td>
                    <td id="totalPedido">0</td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>

              <button id="btnGuardarPedido" class="btn btn-success w-full mt-2">
                <i class="fa-solid fa-save"></i> Guardar Pedido
              </button>
            </div>

            <!-- Incidencias -->
            <div id="tab-incidencia" class="tab-content hidden">
              <!-- a) Registrar Incidencia -->
              <div class="mb-3">
                <div class="flex items-center gap-2 mb-2">
                  <select id="incidenciaCalificacion" class="form-select w-40">
                    <option value="Leve" data-color="green">🟢 Leve</option>
                    <option value="Moderada" data-color="yellow">
                      🟡 Moderada
                    </option>
                    <option value="No grato" data-color="red">
                      🔴 No grato
                    </option>
                  </select>
                  <button id="btnAgregarIncidencia" class="btn btn-success">
                    <i class="fa-solid fa-plus"></i> Agregar Incidencia
                  </button>
                </div>

                <textarea
                  id="incidenciaComentario"
                  class="form-input mb-2"
                  placeholder="Detallar incidencia del cliente..."
                ></textarea>
              </div>

              <!-- b) Listado de Incidencias Registradas -->
              <div>
                <h4 class="font-semibold mb-2">
                  Listado de Incidencias Registradas
                </h4>
                <table class="table" id="tablaIncidencias">
                  <thead>
                    <tr>
                      <th>Calificación</th>
                      <th>Comentario</th>
                      <th>Fecha</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="3" class="text-center text-gray-500">
                        Sin incidencias
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Visitas -->
            <div id="tab-visitas" class="tab-content hidden">
              <table class="table" id="tablaVisitas">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Hab.</th>
                    <th>Entrada</th>
                    <th>Salida</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="4" class="text-center text-gray-500">
                      Sin visitas registradas
                    </td>
                  </tr>
                </tbody>
              </table>

              <!-- Paginación -->
              <div class="flex justify-center items-center mt-3 gap-2 text-sm">
                <button
                  id="prevVisitas"
                  class="px-3 py-1 rounded border bg-gray-100 hover:bg-gray-200 disabled:opacity-50"
                >
                  Anterior
                </button>
                <div id="paginasVisitas" class="flex gap-1"></div>
                <button
                  id="nextVisitas"
                  class="px-3 py-1 rounded border bg-gray-100 hover:bg-gray-200 disabled:opacity-50"
                >
                  Siguiente
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL RESERVA -->
    <div id="modalReserva" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="font-bold text-lg">Registrar Reserva</h2>
          <button onclick="closeReserva()" class="close-btn">Cerrar ✖</button>
        </div>
        <div class="modal-body">
          <!-- Columna 1 -->
          <div class="modal-column">
            <h3 class="section-title">1. HUÉSPED</h3>
            <div class="custom-select" id="resGuestCountry"></div>

            <div class="form-grid">
              <select id="resGuestDocType" class="form-select">
                <option>DNI</option>
                <option>CE</option>
                <option>Pasaporte</option>
              </select>
              <input id="resGuestDocNum" class="form-input" placeholder="N° Documento"/>
            </div>

            <div class="form-grid">
              <input id="resGuestApellido1" class="form-input" placeholder="Primer Apellido"/>
              <input id="resGuestApellido2" class="form-input" placeholder="Segundo Apellido"/>
            </div>
            <input id="resGuestNombres" class="form-input" placeholder="Nombres"/>
            <div class="form-grid">
              <input id="resGuestFechaNac" type="date" class="form-input"/>
              <select id="resGuestGenero" class="form-select">
                <option>Masculino</option>
                <option>Femenino</option>
              </select>
            </div>
          </div>

          <!-- Columna 2 -->
          <div class="modal-column">
            <h3 class="section-title">2. DETALLES RESERVA</h3>
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label font-bold">Fecha Entrada</label>
                <input type="date" id="resFecha" class="form-input"/>
              </div>
              <div class="form-group">
                <label class="form-label font-bold">Hora Entrada</label>
                <input type="time" id="resHora" class="form-input"/>
              </div>
            </div>

            <div class="form-grid">
              <div class="form-group relative">
                <label class="form-label font-bold">Duración (horas)</label>
                <input id="resHoras" type="number" class="form-input pl-8" min="1" max="72" value="12"/>
                <i class="fa-solid fa-clock absolute left-2 top-9 text-gray-500"></i>
              </div>
              <div class="form-group">
                <label class="form-label font-bold">Tarifa (S/)</label>
                <input id="resTarifa" type="number" class="form-input" value="50"/>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label font-bold">Observaciones</label>
              <textarea id="resObs" class="form-input" rows="3"></textarea>
            </div>
          </div>

          <!-- Columna 3 -->
          <div class="modal-column">
            <h3 class="section-title">3. CONFIRMACIÓN</h3>

            <!-- Tabla -->
            <table class="table mb-2">
              <thead>
                <tr>
                  <th>Tipo</th>
                  <th>Descripción</th>
                  <th>Cantidad</th>
                  <th>P. Unit</th>
                  <th>Importe</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Servicio</td>
                  <td>Habitación</td>
                  <td>1</td>
                  <td><span id="resTarifaOut">50.00</span></td>
                  <td><span id="resImporteOut">50.00</span></td>
                </tr>
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="4" class="text-right font-bold">Total:</td>
                  <td id="resTotalFinal">50.00</td>
                </tr>
              </tfoot>
            </table>

            <!-- Datos de comprobante -->
            <div class="flex flex-wrap gap-4 mb-3 text-sm items-center">
              <label><input type="radio" name="resComp" value="boleta" checked/> Boleta</label>
              <label><input type="radio" name="resComp" value="factura"/> Factura</label>
              <input id="resRucField"
                class="form-input flex-1 disabled:bg-gray-100 disabled:text-gray-500 disabled:cursor-not-allowed"
                placeholder="Ingrese RUC" disabled/>
            </div>

            <!-- Pago (igual que en alquiler) -->
            <div class="grid grid-cols-2 gap-2 items-center mb-3">
              <select class="form-select">
                <option>Efectivo</option>
                <option>Tarjeta</option>
                <option>Yape</option>
              </select>
              <input id="resPagoField" class="form-input bg-gray-100" readonly disabled/>
            </div>

            <button onclick="registrarReserva()" class="btn btn-success w-full">
              <i class="fa-solid fa-calendar-check"></i> Registrar Reserva
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL CAJA -->
    <div
      id="modalCaja"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
    >
      <div
        class="bg-white w-full max-w-3xl rounded-xl shadow-2xl flex flex-col overflow-hidden border border-gray-200"
      >
        <div
          class="bg-gradient-to-r from-slate-800 to-slate-700 px-4 py-3 flex justify-between items-center"
        >
          <h2 class="font-semibold text-white flex items-center gap-2">
            <i class="fa-solid fa-cash-register"></i> Caja Hotel Caribbean
          </h2>
          <button
            onclick="closeCaja()"
            class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm shadow"
          >
            ✖
          </button>
        </div>
        <div class="flex border-b text-sm font-medium bg-gray-50">
          <button
            class="caja-tab-btn px-4 py-2 border-r active text-blue-600 font-semibold"
            data-tab="apertura"
          >
            <i class="fa-solid fa-door-open"></i> Apertura y/o Cierre
          </button>
          <button
            class="caja-tab-btn px-4 py-2 border-r text-gray-600"
            data-tab="gastos"
          >
            <i class="fa-solid fa-receipt"></i> Gastos
          </button>
          <button
            class="caja-tab-btn px-4 py-2 border-r text-gray-600"
            data-tab="ajuste"
          >
            <i class="fa-solid fa-sliders"></i> Ajuste
          </button>
          <button
            class="caja-tab-btn px-4 py-2 border-r text-gray-600"
            data-tab="remesas"
          >
            <i class="fa-solid fa-exchange-alt"></i> Remesas
          </button>
          <button
            class="caja-tab-btn px-4 py-2 border-r text-gray-600"
            data-tab="comisiones"
          >
            <i class="fa-solid fa-percent"></i> Comisiones
          </button>
          <button
            class="caja-tab-btn px-4 py-2 text-gray-600"
            data-tab="divisas"
          >
            <i class="fa-solid fa-coins"></i> Divisas
          </button>
        </div>
        <div class="p-6 flex-1 overflow-y-auto text-sm">
          <div id="tab-apertura" class="caja-tab-content space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div class="flex items-center gap-3">
                <i class="fa-solid fa-cash-register text-gray-500"></i
                ><label class="w-32 text-gray-700 font-medium text-xs"
                  >Caja</label
                ><select
                  disabled
                  class="flex-1 border rounded px-3 py-2 text-sm focus:ring focus:ring-blue-200"
                >
                  <option>CAJA 1</option>
                </select>
              </div>
              <div class="flex items-center gap-3">
                <i class="fa-solid fa-money-bill-wave text-red-500"></i
                ><label class="w-32 text-gray-700 font-medium text-xs"
                  >Gastos</label
                ><input
                  disabled
                  type="number"
                  value="0"
                  class="flex-1 border rounded px-3 py-2 text-sm text-red-600 font-bold focus:ring focus:ring-blue-200"
                />
              </div>
              <div class="flex items-center gap-3">
                <i class="fa-solid fa-scale-balanced text-blue-600"></i
                ><label class="w-32 text-gray-700 font-medium text-xs"
                  >Ajuste</label
                ><input
                  disabled
                  type="number"
                  value="0"
                  class="flex-1 border rounded px-3 py-2 text-sm text-blue-600 font-bold focus:ring focus:ring-blue-200"
                />
              </div>
              <div class="flex items-center gap-3">
                <i class="fa-solid fa-key text-green-600"></i
                ><label class="w-32 text-gray-700 font-medium text-xs"
                  >Monto Apertura</label
                ><input
                  disabled
                  value="500"
                  class="flex-1 border rounded px-3 py-2 text-sm focus:ring focus:ring-blue-200"
                />
              </div>
              <div class="flex items-center gap-3">
                <i class="fa-solid fa-lock text-gray-500"></i
                ><label class="w-32 text-gray-700 font-medium text-xs"
                  >Monto Cierre</label
                ><input
                  disabled
                  type="password"
                  value="******"
                  class="flex-1 border rounded px-3 py-2 text-sm focus:ring focus:ring-blue-200"
                />
              </div>
              <div class="flex items-center gap-3">
                <i class="fa-solid fa-clock text-yellow-500"></i
                ><label class="w-32 text-gray-700 font-medium text-xs"
                  >Turno</label
                ><select
                  disabled
                  class="flex-1 border rounded px-3 py-2 text-sm focus:ring focus:ring-blue-200"
                >
                  <option>2º TURNO NOCHE 8PM - 8AM</option>
                </select>
              </div>
              <div class="flex items-center gap-3 col-span-2">
                <i class="fa-solid fa-user text-indigo-600"></i
                ><label class="w-32 text-gray-700 font-medium text-xs"
                  >Usuario</label
                ><input
                  disabled
                  type="text"
                  value="Recepción 1"
                  readonly
                  class="flex-1 border rounded px-3 py-2 text-sm bg-gray-100 font-medium"
                />
              </div>
              <div class="flex items-center gap-3 col-span-2">
                <i class="fa-solid fa-comment text-gray-500"></i
                ><label class="w-32 text-gray-700 font-medium text-xs"
                  >Comentario</label
                ><input
                  type="text"
                  class="flex-1 border rounded px-3 py-2 text-sm focus:ring focus:ring-blue-200"
                />
              </div>
            </div>
          </div>
          <div id="tab-gastos" class="caja-tab-content hidden">
            <p class="text-gray-600">
              <i class="fa-solid fa-receipt mr-2 text-gray-500"></i> Aquí se
              registran los gastos de caja.
            </p>
          </div>
          <div id="tab-ajuste" class="caja-tab-content hidden">
            <p class="text-gray-600">
              <i class="fa-solid fa-sliders mr-2 text-gray-500"></i> Aquí se
              gestionan los ajustes de caja.
            </p>
          </div>
          <div id="tab-remesas" class="caja-tab-content hidden">
            <p class="text-gray-600">
              <i class="fa-solid fa-exchange-alt mr-2 text-gray-500"></i> Aquí
              se registran las remesas.
            </p>
          </div>
          <div id="tab-comisiones" class="caja-tab-content hidden">
            <p class="text-gray-600">
              <i class="fa-solid fa-percent mr-2 text-gray-500"></i> Aquí se
              calculan las comisiones.
            </p>
          </div>
          <div id="tab-divisas" class="caja-tab-content hidden">
            <p class="text-gray-600">
              <i class="fa-solid fa-coins mr-2 text-gray-500"></i> Aquí se
              controlan las divisas.
            </p>
          </div>
        </div>
        <div class="bg-gray-50 px-4 py-3 border-t flex justify-end gap-2">
          <button
            class="px-4 py-2 bg-gray-200 rounded-lg text-sm font-semibold flex items-center gap-2"
            disabled
          >
            <i class="fa-solid fa-door-closed"></i> Cerrar Caja
          </button>
          <button
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-semibold flex items-center gap-2"
          >
            <i class="fa-solid fa-door-open"></i> Aperturar Caja
          </button>
        </div>
      </div>
    </div>

    <!-- MODAL LIMPIEZA -->
    <div id="modalLimpieza" class="modal">
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 relative animate-fadeIn">
        <!-- Cerrar -->
        <button onclick="closeLimpieza()" 
          class="absolute top-3 right-3 text-gray-400 hover:text-red-500 transition">
          <i class="fa-solid fa-xmark text-lg"></i>
        </button>

        <!-- Encabezado -->
        <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
          <i class="fa-solid fa-broom text-blue-600"></i> Habitación en Limpieza
        </h2>

        <!-- Info huésped -->
        <div class="space-y-3 text-sm">
          <div class="p-3 bg-slate-50 rounded-lg border">
            <h3 class="font-semibold text-slate-700 mb-2">Último Huésped</h3>
            <p><b>Nombre:</b> <span id="limpNombre" class="text-slate-600">—</span></p>
            <p><b>Documento:</b> <span id="limpDoc" class="text-slate-600">—</span></p>
          </div>

          <div class="p-3 bg-slate-50 rounded-lg border">
            <h3 class="font-semibold text-slate-700 mb-2">Estadía</h3>
            <p><b>Entrada:</b> <span id="limpEntrada" class="text-slate-600">—</span></p>
            <p><b>Salida:</b> <span id="limpSalida" class="text-slate-600">—</span></p>
            <p><b>Observaciones:</b> <span id="limpObs" class="text-slate-600">—</span></p>
          </div>
        </div>

        <!-- Botón -->
        <div class="mt-5 flex justify-between">
          <button onclick="revertirOcupado(currentLimpRoom)" 
            class="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg font-medium shadow">
            <i class="fa-solid fa-rotate-left"></i> Revertir a Ocupada
          </button>
          <button onclick="closeLimpieza()" 
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium shadow">
            Cerrar
          </button>
        </div>
      </div>
    </div>

    <script>
      function renderPedidosPanel() {
        const panel = document.getElementById("panel-pedidos");
        panel.innerHTML = "";

        rooms.forEach((r) => {
          if (r.estado === "Ocupado" && r.rental?.pedidosPendientes?.length) {
            const card = document.createElement("div");
            card.className = "reserva-card";

            card.innerHTML = `
        <div class="font-bold text-red-600 text-sm">HABITACION ${r.numero}</div>
        <div class="mt-1 space-y-1">
          ${r.rental.pedidosPendientes
            .map(
              (it) => `
            <div class="flex items-center justify-between text-sm">
              <span>${it.cantidad} × ${it.descripcion}</span>
            </div>
          `
            )
            .join("")}
        </div>
        <div class="mt-2 flex justify-between items-center text-xs text-gray-500">
          <button onclick="confirmarEntrega(${r.numero})" 
                  class="px-3 py-1 bg-blue-500 text-white text-xs rounded">
            Confirmar Entrega
          </button>
          <span><i class="fa-regular fa-clock"></i> ${new Date().toLocaleTimeString()}</span>
        </div>
      `;
            panel.appendChild(card);
          }
        });
      }

      function confirmarEntrega(num) {
        const r = rooms.find((x) => x.numero === num);
        if (!r || !r.rental?.pedidosPendientes) return;

        r.rental.pedidosPendientes = []; // ✅ vaciar solo los pendientes

        saveRooms();
        renderPedidosPanel();
        renderPedidosOcupados(r.rental.historialPedidos || []);
      }

      function eliminarPedidoHistorial(num, index) {
        const r = rooms.find((x) => x.numero === num);
        if (!r || !r.rental?.historialPedidos) return;

        const item = r.rental.historialPedidos[index];

        // 🔥 Borrar del historial
        r.rental.historialPedidos.splice(index, 1);

        // 🔥 También eliminar del panel (pedidos pendientes) si existía
        if (r.rental.pedidosPendientes) {
          r.rental.pedidosPendientes = r.rental.pedidosPendientes.filter(
            (p) =>
              !(p.descripcion === item.descripcion && p.precio === item.precio)
          );
        }

        // 🔥 Recalcular deuda
        r.rental.deuda = r.rental.historialPedidos.reduce(
          (sum, p) => sum + p.precio * p.cantidad,
          0
        );

        saveRooms();
        renderPedidosOcupados(r.rental.historialPedidos);
        renderPedidosPanel(); // 👈 refresca el panel
        renderRooms(); // 👈 refresca la tarjeta
      }

      function renderPedidosOcupados(historial) {
        const tbody = document.querySelector("#pedidoTable tbody");
        const tfootTotal = document.getElementById("totalPedido"); // usamos el <td id="totalPedido">
        tbody.innerHTML = "";

        if (!historial.length) {
          tbody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500">Sin pedidos previos</td></tr>`;
          tfootTotal.textContent = "0.00";
          return;
        }

        let total = 0;

        historial.forEach((it, i) => {
          const importe = it.cantidad * it.precio;
          total += importe;

          const tr = document.createElement("tr");
          tr.innerHTML = `
      <td>${it.descripcion}</td>
      <td>${it.cantidad}</td>
      <td>${it.precio.toFixed(2)}</td>
      <td>${importe.toFixed(2)}</td>
      <td>
        <button onclick="eliminarPedidoHistorial(${currentAlqRoom}, ${i})" 
                class="text-red-500 hover:text-red-700">
          <i class="fa-solid fa-trash"></i>
        </button>
      </td>
    `;
          tbody.appendChild(tr);
        });

        // Actualizamos el total en el pie de tabla
        tfootTotal.textContent = total.toFixed(2);

        // 🔥 Actualizamos también la deuda del cliente en el objeto room
        const r = rooms.find((x) => x.numero === currentAlqRoom);
        if (r?.rental) {
          r.rental.deuda = total; // 👈 siempre igual al total actual
          saveRooms();
          renderRooms(); // refresca las tarjetas
        }
      }

      function guardarPedido() {
        if (pedido.length === 0) {
          alert("No hay productos en el pedido");
          return;
        }
        const r = rooms.find((x) => x.numero === currentAlqRoom);
        if (!r) return;

        if (!r.rental) r.rental = {};
        if (!r.rental.pedidosPendientes) r.rental.pedidosPendientes = [];
        if (!r.rental.historialPedidos) r.rental.historialPedidos = [];
        if (!r.rental.deuda) r.rental.deuda = 0;

        pedido.forEach((p) => {
          // acumular en pendientes
          r.rental.pedidosPendientes.push({ ...p });
          // acumular también en historial
          r.rental.historialPedidos.push({ ...p });
        });

        // deuda = total del historial recalculado
        r.rental.deuda = r.rental.historialPedidos.reduce(
          (sum, p) => sum + p.precio * p.cantidad,
          0
        );

        pedido = [];
        renderPedido();
        saveRooms();
        renderRooms();
        renderPedidosPanel();
        closeOcupado();
      }

      document
        .getElementById("btnGuardarPedido")
        .addEventListener("click", guardarPedido);
      //venta ocupado
      let carritoOcupado = []; // empieza vacío
      let currentAlqRoom = null;
      let currentAlqEntradaMs = null;
      // --- Productos básicos ---
      const productosOcupado = [
        { tipo: "Producto", descripcion: "Agua San Luis 500ml", precio: 3 },
        { tipo: "Producto", descripcion: "Gaseosa Coca-Cola 500ml", precio: 5 },
        { tipo: "Producto", descripcion: "Galleta Oreo", precio: 2.5 },
        { tipo: "Producto", descripcion: "Papas Lays Clásicas", precio: 4 },
      ];

      function getCustomSelectValue(containerId) {
        const c = document.getElementById(containerId);
        const s = c?.querySelector(".selected");
        return s?.dataset?.value || null;
      }

      function setCustomSelectValue(containerId, code) {
        const cont = document.getElementById(containerId);
        if (!cont) return;
        const s = cont.querySelector(".selected");
        const c = countries.find((x) => x.code === code) || countries[0];
        if (s) {
          s.innerHTML = `<span><img src="https://flagsapi.com/${c.code}/flat/24.png"> ${c.name}</span><span>▼</span>`;
          s.dataset.value = c.code;
        }
      }

      function calcularTotal(arr) {
        return arr.reduce(
          (sum, p) => sum + Number(p.precio) * Number(p.cantidad || 1),
          0
        );
      }

      function registrarVenta() {
        if (currentAlqRoom == null) {
          alert("No hay habitación seleccionada.");
          return;
        }
        const r = rooms.find((x) => x.numero === currentAlqRoom);
        if (!r) {
          alert("No se encontró la habitación.");
          return;
        }
        if (r.estado !== "Disponible") {
          alert("La habitación no está disponible.");
          return;
        }

        const guest = {
          country: getCustomSelectValue("guestCountry"),
          docTipo: guestDocType.value,
          docNum: guestDocNum.value.trim(),
          apellido1: guestApellido1.value.trim().toUpperCase(),
          apellido2: guestApellido2.value.trim().toUpperCase(),
          nombres: guestNombres.value.trim().toUpperCase(),
          fechaNac: guestFechaNac.value,
          genero: guestGenero.value,
        };
        const acomp = {
          country: getCustomSelectValue("acomCountry"),
          docTipo: acomDocType.value,
          docNum: acomDocNum.value.trim(),
          apellido1: acomApellido1.value.trim().toUpperCase(),
          apellido2: acomApellido2.value.trim().toUpperCase(),
          nombres: acomNombres.value.trim().toUpperCase(),
          fechaNac: acomFechaNac.value,
          genero: acomGenero.value,
        };

        const durH = parseInt(duracionHoras.value) || 1;
        const tarifa = parseFloat(tarifaInput.value) || 0;
        const observ = observacionesInput.value.trim();

        const compSel =
          document.querySelector('input[name="comp"]:checked')?.value ||
          "boleta";
        const ruc = (rucField.value || "").trim();

        const ventaItems = carrito.map((p) => ({
          ...p,
          cantidad: Number(p.cantidad) || 1,
          locked: true, // 🔒 todo lo que entra en la venta queda bloqueado
        }));
        const total = calcularTotal(ventaItems);

        r.estado = "Ocupado";
        r.start = currentAlqEntradaMs;
        r.totalH = durH;
        r.guest = guest.nombres.split(" ")[0] || "—";
        r.rental = {
          entrada: r.start,
          salida: r.start + durH * 3600000,
          duracionH: durH,
          tarifa,
          observ,
          guest,
          acomp,
          venta: { items: ventaItems, total, comp: compSel, ruc },
        };

        saveRooms();
        renderRooms();
        closeAlquiler();
        generarPDFVenta(r, compSel, r.rental.venta);
      }

      async function generarPDFVenta(r, tipo, venta) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: "portrait",
          unit: "mm",
          format: [80, 200], // ancho 80mm, alto dinámico
        });

        let y = 10;
        doc.setFont("courier", "normal");
        doc.setFontSize(9);

        // --- LOGO (si lo quieres, base64 o URL absoluta) ---
        try {
          const logoUrl =
            "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQFpxGfaWiSnip5zDzE--DzTvrsVt5PoPD44Q&s"; // reemplaza con tu logo real
          const img = await fetch(logoUrl)
            .then((res) => res.blob())
            .then((b) => {
              return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(b);
              });
            });
          doc.addImage(img, "PNG", 25, y, 30, 30);
          y += 35 ;
        } catch (e) {
          doc.text("HOTEL CARIBBEAN", 40, y, { align: "center" });
          y += 6;
        }

        // --- Datos empresa ---
        doc.setFontSize(9);
        doc.text("RUC: 20502468767", 40, y, { align: "center" });
        y += 4;
        doc.text("INVERSIONES CARIBBEAN S.A.C.", 40, y, { align: "center" });
        y += 4;
        doc.text("Jr. C. A. Salaverry 3560", 40, y, { align: "center" });
        y += 4;
        doc.text("Los Olivos - Lima", 40, y, { align: "center" });
        y += 8;

        // --- Tipo comprobante ---
        doc.setFontSize(10);
        doc.setFont("courier", "bold");
        doc.text(
          tipo === "factura" ? "FACTURA ELECTRONICA" : "BOLETA ELECTRONICA",
          40,
          y,
          { align: "center" }
        );
        y += 8;
        doc.setFont("courier", "normal");

        // --- Datos cliente ---
        doc.setFontSize(9);
        doc.text("Fecha: " + new Date().toLocaleString(), 2, y);
        y += 5;
        doc.text(
          "Cliente: " +
            (r.rental.guest?.nombres || "") +
            " " +
            (r.rental.guest?.apellido1 || "") +
             " " +
            (r.rental.guest?.apellido2 || ""),
          2,
          y
        );
        y += 5;
        doc.text(
   
            (tipo === "factura"
              ? "RUC: " + (venta.ruc || "")
              : (r.rental.guest?.docTipo || "") +
                ":  " +
                (r.rental.guest?.docNum || "")),
          2,
          y
        );
        y += 6;

        // --- Datos habitación ---
        doc.text("Duracion: " + (r.rental.duracionH || 0) + " h", 2, y);
        y += 5;
        doc.text("Tarifa: S/ " + (r.rental.tarifa || 0).toFixed(2), 2, y);
        y += 8;

        // --- Tabla productos ---
        doc.setFont("courier", "bold");
        doc.text("DESC          CANT    P.UNIT      IMP", 2, y);
        y += 4;
        doc.setFont("courier", "normal");
        doc.line(2, y, 78, y);
        y += 4;

        venta.items.forEach((p) => {
          const imp = (p.precio * p.cantidad).toFixed(2);
          doc.text(p.descripcion.substring(0, 12), 2, y);
          doc.text(String(p.cantidad), 35, y, { align: "right" });
          doc.text(p.precio.toFixed(2), 55, y, { align: "right" });
          doc.text(imp, 78, y, { align: "right" });
          y += 5;
        });

        // --- Totales ---
        y += 2;
        doc.line(2, y, 78, y);
        y += 5;
        doc.setFont("courier", "bold");
        doc.text("TOTAL: S/ " + venta.total.toFixed(2), 78, y, {
          align: "right",
        });
        doc.setFont("courier", "normal");

        // --- Mensaje ---
        y += 10;
        doc.setFontSize(9);
        doc.text("¡Gracias por su visita!", 40, y, { align: "center" });

        // Descargar PDF
        doc.save(`${tipo}_${Date.now()}.pdf`);
      }

      document
        .getElementById("btnRegistrarVenta")
        .addEventListener("click", registrarVenta);

      // --- Buscador ---
      const searchProductOcupado = document.getElementById(
        "searchProductOcupado"
      );
      const productResultsOcupado = document.getElementById(
        "productResultsOcupado"
      );
      const addProductBtnOcupado = document.getElementById(
        "addProductBtnOcupado"
      );

      // Mostrar lista mientras escribo
      searchProductOcupado.addEventListener("input", () => {
        const q = searchProductOcupado.value.toLowerCase();
        productResultsOcupado.innerHTML = "";
        if (!q) {
          productResultsOcupado.classList.add("hidden");
          return;
        }
        const filtered = productosOcupado.filter((p) =>
          p.descripcion.toLowerCase().includes(q)
        );
        if (filtered.length === 0) {
          productResultsOcupado.innerHTML =
            "<li class='px-2 py-1 text-gray-500'>No encontrado</li>";
        } else {
          filtered.forEach((p) => {
            const li = document.createElement("li");
            li.className = "px-2 py-1 hover:bg-blue-100 cursor-pointer";
            li.textContent = `${p.descripcion} (S/ ${p.precio})`;
            li.onclick = () => {
              agregarAlCarritoOcupado({ ...p, cantidad: 1 });
              productResultsOcupado.classList.add("hidden");
              searchProductOcupado.value = "";
            };
            productResultsOcupado.appendChild(li);
          });
        }
        productResultsOcupado.classList.remove("hidden");
      });

      // Agregar con el botón "+"
      addProductBtnOcupado.addEventListener("click", () => {
        const q = searchProductOcupado.value.toLowerCase();
        const p = productosOcupado.find((x) =>
          x.descripcion.toLowerCase().includes(q)
        );
        if (p) {
          agregarAlCarritoOcupado({ ...p, cantidad: 1 });
          searchProductOcupado.value = "";
          productResultsOcupado.classList.add("hidden");
        }
      });

      // --- Agregar producto al carrito ---
      function agregarAlCarritoOcupado(producto) {
        // Si ya existe, sumamos cantidad
        const existente = carritoOcupado.find(
          (p) => p.descripcion === producto.descripcion && p.tipo !== "Servicio"
        );
        if (existente) {
          existente.cantidad += producto.cantidad;
        } else {
          carritoOcupado.push(producto);
        }
        renderCarritoOcupado();
      }

      function actualizarCantidadOcupado(i, val) {
        carritoOcupado[i].cantidad = parseInt(val) || 1;
        renderCarritoOcupado(); // 🔥 Redibuja la tabla con los nuevos importes
      }

      function calcularTotalOcupado(arr) {
        // solo suma productos que NO sean "Servicio"
        return arr
          .filter((p) => p.tipo !== "Servicio")
          .reduce((sum, p) => sum + p.precio * p.cantidad, 0);
      }

      function renderCarritoOcupado() {
        const tbody = document.querySelector("#consumoTableOcupado tbody");
        tbody.innerHTML = "";

        carritoOcupado.forEach((p, i) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td>${p.tipo}</td>
          <td>${p.descripcion}</td>
          <td>
            ${
              p.locked
                ? p.cantidad // 🔒 ya vendido → fijo
                : `<input type="number" min="1" value="${p.cantidad}" 
                    class="w-16 border rounded px-1" 
                    onchange="actualizarCantidadOcupado(${i}, this.value)">`
            }
          </td>
          <td>${p.precio.toFixed(2)}</td>
          <td>${(p.precio * p.cantidad).toFixed(2)}</td>
          <td>
            ${
              p.locked
                ? ""
                : `<button onclick="eliminarCarritoOcupado(${i})" class="text-red-500"><i class="fa-solid fa-trash"></i></button>`
            }
          </td>
        `;
          tbody.appendChild(tr);
        });

        const total = calcularTotalOcupado(carritoOcupado);
        document.getElementById("totalVentaOcupado").textContent =
          total.toFixed(2);
        document.getElementById("recibiFieldOcupado").value = total.toFixed(2);
      }

      function eliminarCarritoOcupado(i) {
        carritoOcupado.splice(i, 1);
        renderCarritoOcupado();
      }

      // RUC habilitar / deshabilitar
      document.querySelectorAll("input[name='compOcupado']").forEach((r) => {
        r.addEventListener("change", () => {
          const ruc = document.getElementById("rucFieldOcupado");
          if (r.value === "factura" && r.checked) {
            ruc.disabled = false;
            ruc.focus();
          } else {
            ruc.disabled = true;
            ruc.value = "";
          }
        });
      });

      function initModalOcupado() {
        renderCarritoOcupado();
      }

      function openOcupado(num) {
        currentAlqRoom = num;
        const modal = document.getElementById("modalOcupado");
        const r = rooms.find((x) => x.numero === num);
        modal.querySelector("h2").textContent =
          "Habitación " + num + " (Ocupada)";
        const rental = r?.rental || {};

        const g = rental.guest || {};
        nombresOcupado.value = g.nombres || "—";
        apellido1Ocupado.value = g.apellido1 || "—";
        apellido2Ocupado.value = g.apellido2 || "—";
        docOcupado.value = g.docNum || "—";
        fechaNacOcupado.value = g.fechaNac || "";
        if (g.country) setCustomSelectValue("guestCountryOcupado", g.country);

        const a = rental.acomp || {};
        nombresAcomOcupado.value = a.nombres || "—";
        apellido1AcomOcupado.value = a.apellido1 || "—";
        apellido2AcomOcupado.value = a.apellido2 || "—";
        docAcomOcupado.value = a.docNum || "—";
        fechaNacAcomOcupado.value = a.fechaNac || "";
        if (a.country) setCustomSelectValue("acomCountryOcupado", a.country);

        entradaInfoOcupado.value = rental.entrada
          ? new Date(rental.entrada).toLocaleString()
          : "";
        salidaInfoOcupado.value = rental.salida
          ? new Date(rental.salida).toLocaleString()
          : "";
        duracionOcupado.value = rental.duracionH || 0;
        tarifaOcupado.value = rental.tarifa ?? 0;
        obsOcupado.value = rental.observ || "";

        carritoOcupado = (rental.venta?.items || []).map((p) => ({
          ...p,
          locked: true,
        }));
        renderCarritoOcupado();
        renderPedidosOcupados(r.rental.historialPedidos || []);

        modal.classList.add("show");
        modal
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.remove("active"));
        modal
          .querySelectorAll(".tab-content")
          .forEach((c) => c.classList.add("hidden"));
        modal.querySelector("[data-tab='pedido']").classList.add("active");
        modal.querySelector("#tab-pedido").classList.remove("hidden");
      }

      function closeOcupado() {
        document.getElementById("modalOcupado").classList.remove("show");
      }

      // Datos de prueba (puedes reemplazar con datos reales después)
      const visitas = [
        { fecha: "04/08/2025", hab: "306", entrada: "20:15", salida: "--" },
        { fecha: "04/12/2024", hab: "511", entrada: "15:23", salida: "21:46" },
        { fecha: "03/08/2024", hab: "804", entrada: "15:29", salida: "22:19" },
        { fecha: "23/07/2024", hab: "809", entrada: "13:39", salida: "22:18" },
        { fecha: "10/07/2024", hab: "509", entrada: "17:52", salida: "22:08" },
        { fecha: "08/07/2024", hab: "204", entrada: "17:57", salida: "22:31" },
        { fecha: "22/10/2023", hab: "605", entrada: "17:01", salida: "21:38" },
        { fecha: "07/06/2023", hab: "507", entrada: "00:44", salida: "13:18" },
        { fecha: "15/05/2023", hab: "607", entrada: "18:19", salida: "00:31" },
        { fecha: "31/03/2023", hab: "508", entrada: "00:44", salida: "11:23" },
      ];

      let visitasPagina = 1;
      const visitasPorPagina = 5;

      function renderVisitas() {
        const tbody = document.querySelector("#tablaVisitas tbody");
        tbody.innerHTML = "";

        const inicio = (visitasPagina - 1) * visitasPorPagina;
        const fin = inicio + visitasPorPagina;
        const paginaData = visitas.slice(inicio, fin);

        if (paginaData.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500">Sin visitas registradas</td></tr>`;
        } else {
          paginaData.forEach((v) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
          <td>${v.fecha}</td>
          <td>${v.hab}</td>
          <td>${v.entrada}</td>
          <td>${v.salida}</td>
        `;
            tbody.appendChild(tr);
          });
        }

        // actualizar botones de página
        const totalPaginas = Math.ceil(visitas.length / visitasPorPagina);
        const paginasContainer = document.getElementById("paginasVisitas");
        paginasContainer.innerHTML = "";

        for (let i = 1; i <= totalPaginas; i++) {
          const btn = document.createElement("button");
          btn.textContent = i;
          btn.className =
            "px-3 py-1 rounded border " +
            (i === visitasPagina
              ? "bg-blue-600 text-white font-bold"
              : "bg-white hover:bg-gray-100");

          btn.addEventListener("click", () => {
            visitasPagina = i;
            renderVisitas();
          });

          paginasContainer.appendChild(btn);
        }

        // actualizar prev/next
        document.getElementById("prevVisitas").disabled = visitasPagina === 1;
        document.getElementById("nextVisitas").disabled =
          visitasPagina === totalPaginas;
      }

      document.getElementById("prevVisitas").addEventListener("click", () => {
        if (visitasPagina > 1) {
          visitasPagina--;
          renderVisitas();
        }
      });

      document.getElementById("nextVisitas").addEventListener("click", () => {
        const totalPaginas = Math.ceil(visitas.length / visitasPorPagina);
        if (visitasPagina < totalPaginas) {
          visitasPagina++;
          renderVisitas();
        }
      });

      // Inicializar
      renderVisitas();

      let incidencias = [];

      document
        .getElementById("btnAgregarIncidencia")
        .addEventListener("click", () => {
          const comentario = document
            .getElementById("incidenciaComentario")
            .value.trim();
          const select = document.getElementById("incidenciaCalificacion");
          const calificacion = select.value;
          const color = select.options[select.selectedIndex].dataset.color;

          if (!comentario) {
            alert("Debe ingresar un detalle de la incidencia.");
            return;
          }

          const nuevaIncidencia = {
            calificacion,
            color,
            comentario,
            fecha: new Date().toLocaleString(),
          };

          incidencias.push(nuevaIncidencia);
          renderIncidencias();

          // limpiar campos
          document.getElementById("incidenciaComentario").value = "";
        });

      function renderIncidencias() {
        const tbody = document.querySelector("#tablaIncidencias tbody");
        tbody.innerHTML = "";

        if (incidencias.length === 0) {
          tbody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-500">Sin incidencias</td></tr>`;
          return;
        }

        incidencias.forEach((i) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
        <td style="color:${i.color}; font-weight:bold;">${i.calificacion}</td>
        <td>${i.comentario}</td>
        <td>${i.fecha}</td>
      `;
          tbody.appendChild(tr);
        });
      }

      // Productos básicos (se pueden compartir con Venta)
      const productosPedido = [
        { descripcion: "Agua San Luis 500ml", precio: 3 },
        { descripcion: "Gaseosa Coca-Cola 500ml", precio: 5 },
        { descripcion: "Galleta Oreo", precio: 2.5 },
        { descripcion: "Papas Lays Clásicas", precio: 4 },
      ];

      let pedido = [];

      const searchPedido = document.getElementById("searchPedido");
      const pedidoResults = document.getElementById("pedidoResults");
      const pedidoBody = document.querySelector("#pedidoTable tbody");
      const totalPedido = document.getElementById("totalPedido");

      // Buscar productos
      searchPedido.addEventListener("input", () => {
        const q = searchPedido.value.toLowerCase();
        pedidoResults.innerHTML = "";
        if (!q) {
          pedidoResults.classList.add("hidden");
          return;
        }
        const filtrados = productosPedido.filter((p) =>
          p.descripcion.toLowerCase().includes(q)
        );
        filtrados.forEach((p) => {
          const li = document.createElement("li");
          li.textContent = `${p.descripcion} - S/ ${p.precio}`;
          li.className = "px-3 py-1 cursor-pointer hover:bg-blue-50";
          li.onclick = () => agregarPedido(p);
          pedidoResults.appendChild(li);
        });
        pedidoResults.classList.remove("hidden");
      });

      function agregarPedido(prod) {
        const item = pedido.find((p) => p.descripcion === prod.descripcion);
        if (item) {
          item.cantidad++;
        } else {
          pedido.push({ ...prod, cantidad: 1 });
        }
        renderPedido();
        pedidoResults.classList.add("hidden");
        searchPedido.value = "";
      }

      function eliminarPedido(index) {
        pedido.splice(index, 1);
        renderPedido();
      }

      function actualizarPedidoCantidad(i, val) {
        pedido[i].cantidad = parseInt(val) || 1;
        renderPedido();
      }

      function renderPedido() {
        pedidoBody.innerHTML = "";
        let total = 0;
        if (pedido.length === 0) {
          pedidoBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500">Sin productos</td></tr>`;
        } else {
          pedido.forEach((p, i) => {
            const importe = p.precio * p.cantidad;
            total += importe;
            const tr = document.createElement("tr");
            tr.innerHTML = `
          <td>${p.descripcion}</td>
          <td><input type="number" min="1" value="${
            p.cantidad
          }" class="w-16 border rounded px-1" onchange="actualizarPedidoCantidad(${i}, this.value)"></td>
          <td>${p.precio}</td>
          <td>${importe.toFixed(2)}</td>
          <td><button onclick="eliminarPedido(${i})" class="text-red-500"><i class="fa-solid fa-trash"></i></button></td>
        `;
            pedidoBody.appendChild(tr);
          });
        }
        totalPedido.textContent = total.toFixed(2);
      }

      // Control de tabs (Venta, Pedido, Incidencia, Visitas)
      document.querySelectorAll(".tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          // quitar activo a todos
          document
            .querySelectorAll(".tab")
            .forEach((t) => t.classList.remove("active"));
          document
            .querySelectorAll(".tab-content")
            .forEach((c) => c.classList.add("hidden"));

          // activar este
          tab.classList.add("active");
          const target = tab.dataset.tab; // ejemplo: "pedido"
          document.getElementById(`tab-${target}`).classList.remove("hidden");
        });
      });

      // Productos básicos de ejemplo
      const productos = [
        { tipo: "Bebida", descripcion: "Agua San Luis 500ml", precio: 3 },
        { tipo: "Bebida", descripcion: "Gaseosa Coca-Cola 500ml", precio: 5 },
        { tipo: "Snack", descripcion: "Galleta Oreo", precio: 2.5 },
        { tipo: "Snack", descripcion: "Papas Lays Clásicas", precio: 4 },
      ];

      // Carrito inicia con la habitación
      let carrito = [
        {
          tipo: "Servicio",
          descripcion: "Habitación",
          precio: 50,
          cantidad: 1,
        },
      ];

      const searchInput = document.getElementById("searchProduct");
      const resultsBox = document.getElementById("productResults");
      const tableBody = document.querySelector("#consumoTable tbody");
      const totalVenta = document.getElementById("totalVenta");

      searchInput.addEventListener("input", () => {
        const q = searchInput.value.toLowerCase();
        resultsBox.innerHTML = "";
        if (!q) {
          resultsBox.classList.add("hidden");
          return;
        }
        const filtrados = productos.filter((p) =>
          p.descripcion.toLowerCase().includes(q)
        );
        filtrados.forEach((p) => {
          const li = document.createElement("li");
          li.textContent = `${p.descripcion} - S/ ${p.precio}`;
          li.className = "px-3 py-1 cursor-pointer hover:bg-blue-50";
          li.onclick = () => agregarProducto(p);
          resultsBox.appendChild(li);
        });
        resultsBox.classList.remove("hidden");
      });

      function agregarProducto(prod) {
        const item = carrito.find((p) => p.descripcion === prod.descripcion);
        if (item) {
          item.cantidad++;
        } else {
          carrito.push({ ...prod, cantidad: 1 });
        }
        renderCarrito();
        resultsBox.classList.add("hidden");
        searchInput.value = "";
      }

      function eliminarProducto(index) {
        // Evitar borrar el servicio de habitación
        if (carrito[index].tipo === "Servicio") return;
        carrito.splice(index, 1);
        renderCarrito();
      }

      function renderCarrito() {
        tableBody.innerHTML = "";
        let total = 0;
        carrito.forEach((p, i) => {
          const importe = p.precio * p.cantidad;
          total += importe;
          const tr = document.createElement("tr");
          tr.innerHTML = `
        <td>${p.tipo}</td>
        <td>${p.descripcion}</td>
        <td><input type="number" min="1" value="${
          p.cantidad
        }" class="w-16 border rounded px-1" onchange="actualizarCantidad(${i}, this.value)"></td>
        <td>${p.precio}</td>
        <td>${importe.toFixed(2)}</td>
        <td>
          ${
            p.tipo !== "Servicio"
              ? `<button onclick="eliminarProducto(${i})" class="text-red-500"><i class="fa-solid fa-trash"></i></button>`
              : ""
          }
        </td>
      `;
          tableBody.appendChild(tr);
        });
        totalVenta.textContent = total.toFixed(2);

        // Recibí siempre igual al total
        document.getElementById("recibiField").value = total.toFixed(2);
      }

      function actualizarCantidad(i, val) {
        carrito[i].cantidad = parseInt(val) || 1;
        renderCarrito();
      }

      // Control RUC habilitar/deshabilitar
      document.querySelectorAll("input[name='comp']").forEach((radio) => {
        radio.addEventListener("change", () => {
          const rucField = document.getElementById("rucField");
          if (radio.value === "factura" && radio.checked) {
            rucField.disabled = false;
            rucField.focus(); // 🔥 se pone listo para digitar
          } else {
            rucField.disabled = true;
            rucField.value = "";
          }
        });
      });

      // Render inicial con el servicio cargado
      renderCarrito();

      const countries = [
        { code: "PE", name: "Perú" },
        { code: "CL", name: "Chile" },
        { code: "AR", name: "Argentina" },
        { code: "BR", name: "Brasil" },
        { code: "CO", name: "Colombia" },
        { code: "EC", name: "Ecuador" },
        { code: "MX", name: "México" },
        { code: "ES", name: "España" },
        { code: "US", name: "Estados Unidos" },
      ];

      // Renderizar combo personalizado
      function createCustomSelect(containerId, defaultCode = "PE") {
        const container = document.getElementById(containerId);
        if (!container) return;

        container.classList.add("custom-select");
        const selected = document.createElement("div");
        selected.className = "selected";
        container.appendChild(selected);

        const optionsBox = document.createElement("div");
        optionsBox.className = "options";
        container.appendChild(optionsBox);

        countries.forEach((c) => {
          const opt = document.createElement("div");
          opt.className = "option";
          opt.dataset.value = c.code;
          opt.innerHTML = `<img src="https://flagsapi.com/${c.code}/flat/24.png"> ${c.name}`;
          optionsBox.appendChild(opt);

          opt.addEventListener("click", () => {
            selected.innerHTML = `<span><img src="https://flagsapi.com/${c.code}/flat/24.png"> ${c.name}</span><span>▼</span>`;
            selected.dataset.value = c.code;
            container.classList.remove("open");
          });
        });

        // Valor inicial
        const defaultCountry =
          countries.find((c) => c.code === defaultCode) || countries[0];
        selected.innerHTML = `<span><img src="https://flagsapi.com/${defaultCountry.code}/flat/24.png"> ${defaultCountry.name}</span><span>▼</span>`;
        selected.dataset.value = defaultCountry.code;

        // Abrir/cerrar
        selected.addEventListener("click", () => {
          container.classList.toggle("open");
        });

        // Cerrar al hacer clic fuera
        document.addEventListener("click", (e) => {
          if (!container.contains(e.target)) {
            container.classList.remove("open");
          }
        });
      }

      // Inicializar combos de nacionalidad guestCountry
      createCustomSelect("guestCountry");
      createCustomSelect("acomCountry");
      createCustomSelect("guestCountryOcupado");
      createCustomSelect("acomCountryOcupado");
      createCustomSelect("resGuestCountry");

      const ROOMS_KEY = "hc_pms_rooms_v1";
      let rooms = loadRooms();
      let timerHandles = [];

      function loadRooms() {
        const raw = localStorage.getItem(ROOMS_KEY);
        if (raw) {
          try {
            const arr = JSON.parse(raw);

            // 🔒 Validar estados: solo "Ocupado" o "Limpieza". Todo lo demás → "Disponible"
            arr.forEach(r => {
              if (r.estado !== "Ocupado" && r.estado !== "Limpieza") {
                r.estado = "Disponible";
                r.rental = null;          // por si quedó basura
                r.limpiezaStart = null;   // reseteo seguro
                r.cleaningEnd = 0;
              }
            });

            return arr;
          } catch (e) {
            console.warn("Error cargando rooms, regenerando seed:", e);
          }
        }

        // Seed inicial fijo
        const arr = [];
        for (let piso = 1; piso <= 5; piso++) {
          for (let n = 1; n <= 10; n++) {
            const numero = piso * 100 + n;
            arr.push({
              piso,
              numero,
              estado: "Disponible",
              guest: "",
              totalH: 0,
              start: 0,
              limpiezaStart: null,
              cleaningEnd: 0,
            });
          }
        }

        localStorage.setItem(ROOMS_KEY, JSON.stringify(arr));
        return arr;
      }

      function saveRooms() {
        localStorage.setItem(ROOMS_KEY, JSON.stringify(rooms));
      }

      function msToHMin(ms) {
        ms = Math.max(0, ms);
        const totalMin = Math.ceil(ms / 60000);
        const h = Math.floor(totalMin / 60);
        const m = totalMin % 60;
        return `${h}h ${m}m`;
      }

      function clearTimers() {
        timerHandles.forEach(clearInterval);
        timerHandles = [];
      }

      function renderRooms() {
        clearTimers();
        const wrap = document.getElementById("rooms");
        wrap.innerHTML = "";
        let disp = 0,
          ocup = 0,
          limp = 0;

        for (let piso = 1; piso <= 5; piso++) {
          const row = document.createElement("div");
          row.className = "floor-row";
          const lbl = document.createElement("div");
          lbl.className = "floor-label";
          lbl.textContent = "PISO " + piso;
          row.appendChild(lbl);
          const grid = document.createElement("div");
          grid.className = "floor-grid";

          rooms
            .filter((r) => r.piso === piso)
            .forEach((r) => {
              const card = document.createElement("div");
              card.className = "room-card";

              if (r.estado === "Disponible") {
                disp++;
                card.innerHTML = `<div class="room-center"><div class="room-num">${r.numero}</div></div>
              <div class="badge-dispo"><i class="fa-solid fa-bed text-[12px]"></i>Disponible</div>`;
                card.onclick = () => openAlquiler(r.numero);
              }

              if (r.estado === "Limpieza") {
                limp++;
                card.innerHTML = `<div class="room-center">
                  <div class="clean-time" data-bind="timer">00:00:00</div>
                  <div class="room-num">${r.numero}</div>
                </div>
                <button class="badge-clean"><i class="fa-solid fa-broom text-[12px]"></i>Finalizar</button>`;

                // finalizar limpieza -> disponible
                card.onclick = () => openLimpieza(r.numero);
                card.querySelector(".badge-clean").onclick = (ev) => {
                  ev.stopPropagation();
                  finalizarLimpieza(r.numero);
                };

                // ⏱ iniciar cronómetro
                const span = card.querySelector('[data-bind="timer"]');
                startCleaningTimer(span, r.limpiezaStart);
              }

              if (r.estado === "Ocupado") {
                ocup++;
                card.innerHTML = `
                  <div class="room-center">
                    <div class="room-num">${r.numero}</div>
                    <div class="room-name">${r.guest || "—"}</div>
                  </div>
                  <div class="busy-bar">
                    <div class="busy-left" style="width:60%"><span data-bind="timer">--:--:--</span></div>
                    <button class="busy-right">Salir</button>
                  </div>
                `;

                // 🔥 Verificamos que exista historial con productos
                if (
                  r.rental?.historialPedidos &&
                  r.rental.historialPedidos.length > 0
                ) {
                  const deuda = r.rental.historialPedidos.reduce(
                    (sum, p) => sum + p.precio * p.cantidad,
                    0
                  );

                  if (deuda > 0) {
                    const deudaDiv = document.createElement("div");
                    deudaDiv.className =
                      "deuda-badge absolute top-0 right-0 bg-red-600 text-white text-xs font-bold px-1 rounded-bl";
                    deudaDiv.textContent = "S/ " + deuda.toFixed(2);
                    card.appendChild(deudaDiv);
                    card.style.position = "relative";
                  }
                }

                const left = card.querySelector(".busy-left");
                const span = left.querySelector('[data-bind="timer"]');
                startTimer(span, r.start, r.totalH);

                // 👉 Al hacer click en la tarjeta, abrir modal de ocupado
                card.onclick = () => openOcupado(r.numero);

                // Botón de salir -> checkout
                card.querySelector(".busy-right").onclick = (ev) => {
                  ev.stopPropagation();
                  if (confirm("¿Está seguro de finalizar la visita de la habitación " + r.numero + "?")) {
                    checkout(r.numero);
                  }
                };
              }
              grid.appendChild(card);
            });

          row.appendChild(grid);
          wrap.appendChild(row);
        }
        document.getElementById("kpiDisp").textContent = disp;
        document.getElementById("kpiOcup").textContent = ocup;
        document.getElementById("kpiLimp").textContent = limp;
      }

      function startTimer(node, startMs, totalH) {
        const total = totalH * 3600000;
        const card = node.closest(".room-card");

        function fmt(ms) {
          const s = Math.floor(ms / 1000);
          const hh = String(Math.floor(s / 3600)).padStart(2, "0");
          const mm = String(Math.floor((s % 3600) / 60)).padStart(2, "0");
          const ss = String(s % 60).padStart(2, "0");
          return `${hh}:${mm}:${ss}`;
        }

        function tick() {
          const rest = total - (Date.now() - startMs);

          if (rest > 0) {
            // quedan minutos
            node.textContent = fmt(rest);

            // ⚠️ Parpadea cuando restan <= 10 min
            if (rest <= 10 * 60000) {
              card.classList.add("warning-blink");
            }
          } else {
            // vencido
            const excedido = Date.now() - (startMs + total);
            node.textContent = "+" + fmt(excedido);

            card.classList.remove("warning-blink");
            card.classList.add("vencido");
          }
        }

        tick();
        const h = setInterval(tick, 1000);
        timerHandles.push(h);
      }

      function startCleaningTimer(node, startMs) {
        function fmt(ms) {
          ms = Math.max(0, ms);
          const s = Math.floor(ms / 1000);
          const hh = String(Math.floor(s / 3600)).padStart(2, "0");
          const mm = String(Math.floor((s % 3600) / 60)).padStart(2, "0");
          const ss = String(s % 60).padStart(2, "0");
          return `${hh}:${mm}:${ss}`;
        }
        function tick() {
          const elapsed = Date.now() - startMs;
          node.textContent = fmt(elapsed);
        }
        tick();
        const h = setInterval(tick, 1000);
        timerHandles.push(h);
      }

      let currentLimpRoom = null;
      function openLimpieza(num) {
        currentLimpRoom = num;
        const r = rooms.find(x => x.numero === num);
        if (!r || !r.lastRental) {
          alert("No hay historial de huésped para esta habitación.");
          return;
        }

        // rellenamos modal
        document.getElementById("limpNombre").textContent =
          (r.lastRental.guest?.nombres || "") +
          " " +
          (r.lastRental.guest?.apellido1 || "") +
          " " +
          (r.lastRental.guest?.apellido2 || "");
        document.getElementById("limpDoc").textContent =
          (r.lastRental.guest?.docTipo || "") +
          " " +
          (r.lastRental.guest?.docNum || "");
        document.getElementById("limpEntrada").textContent = r.lastRental.entrada
          ? new Date(r.lastRental.entrada).toLocaleString()
          : "—";
        document.getElementById("limpSalida").textContent = r.lastRental.salida
          ? new Date(r.lastRental.salida).toLocaleString()
          : "—";
        document.getElementById("limpObs").textContent =
          r.lastRental.observ || "—";

        document.getElementById("modalLimpieza").classList.add("show");
      }

      function closeLimpieza() {
        document.getElementById("modalLimpieza").classList.remove("show");
      }

      function revertirOcupado(numero) {
        const r = rooms.find((x) => x.numero === numero);
        if (!r || !r.lastRental) {
          alert("No hay historial para revertir esta habitación.");
          return;
        }

        // Restaurar alquiler previo
        r.estado = "Ocupado";
        r.rental = { ...r.lastRental };
        r.start = r.lastRental.entrada;   // restauramos inicio
        r.totalH = r.lastRental.duracionH;

        // Quitar datos de limpieza
        r.limpiezaStart = null;
        r.cleaningEnd = 0;

        saveRooms();
        renderRooms();
        closeLimpieza();
      }

      // Acciones de estado
      function finalizarLimpieza(numero) {
        const r = rooms.find((x) => x.numero === numero);
        if (!r) return;
        r.estado = "Disponible";
        r.cleaningEnd = 0;
        saveRooms();
        renderRooms();
      }

      function checkout(numero) {
        const r = rooms.find((x) => x.numero === numero);
        if (!r) return;

        // Guardamos historial del último huésped
        r.lastRental = { ...r.rental };

        // Pasamos a limpieza
        r.estado = "Limpieza";
        r.guest = "";
        r.totalH = 0;
        r.start = 0;
        r.limpiezaStart = Date.now();
        r.cleaningEnd = 0;

        saveRooms();
        renderRooms();
      }

      // Abrir/Cerrar modales
      function switchTab(which) {
        document
          .getElementById("panel-pedidos")
          .classList.toggle("hidden", which !== "pedidos");
        document
          .getElementById("panel-reservas")
          .classList.toggle("hidden", which !== "reservas");
        document
          .getElementById("tab-pedidos")
          .classList.toggle("active", which === "pedidos");
        document
          .getElementById("tab-reservas")
          .classList.toggle("active", which === "reservas");
      }

      function openAlquiler(num) {
        currentAlqRoom = num;
        currentAlqEntradaMs = Date.now();

        const modal = document.getElementById("modalAlquiler");
        modal.querySelector("h2").textContent = "Alquiler Habitación " + num;

        // 🔹 Reiniciar carrito (solo habitación)
        carrito = [
          {
            tipo: "Servicio",
            descripcion: "Habitación",
            precio: 50,
            cantidad: 1,
          },
        ];
        renderCarrito(); // 🔥 refresca la tabla con ese único ítem

        // 🔹 LIMPIAR CAMPOS DE HUÉSPED
        document.getElementById("guestDocNum").value = "";
        document.getElementById("guestApellido1").value = "";
        document.getElementById("guestApellido2").value = "";
        document.getElementById("guestNombres").value = "";
        document.getElementById("guestFechaNac").value = "";
        document.getElementById("guestDocType").selectedIndex = 0;
        document.getElementById("guestGenero").selectedIndex = 0;

        // 🔹 LIMPIAR CAMPOS DE ACOMPAÑANTE
        document.getElementById("acomDocNum").value = "";
        document.getElementById("acomApellido1").value = "";
        document.getElementById("acomApellido2").value = "";
        document.getElementById("acomNombres").value = "";
        document.getElementById("acomFechaNac").value = "";
        document.getElementById("acomDocType").selectedIndex = 0;
        document.getElementById("acomGenero").selectedIndex = 0;

        // 🔹 LIMPIAR HABITACIÓN (observaciones, duración y tarifa por defecto)
        document.getElementById("observacionesInput").value = "";
        document.getElementById("duracionHoras").value = 12;
        document.getElementById("tarifaInput").value = 50;

        // Hora de entrada/salida
        document.getElementById("entradaInfo").value = new Date(
          currentAlqEntradaMs
        ).toLocaleString();
        function updateSalidaPreview() {
          const dur =
            parseInt(document.getElementById("duracionHoras").value) || 1;
          const salidaMs = currentAlqEntradaMs + dur * 3600000;
          document.getElementById("salidaInfo").value = new Date(
            salidaMs
          ).toLocaleString();
        }
        document.getElementById("duracionHoras").oninput = updateSalidaPreview;
        updateSalidaPreview();

        // Abrir modal
        modal.classList.add("show");
        modal
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.remove("active"));
        modal
          .querySelectorAll(".tab-content")
          .forEach((c) => c.classList.add("hidden"));
        modal.querySelector('.tab[data-tab="venta"]').classList.add("active");
        modal.querySelector("#tab-venta").classList.remove("hidden");

        document.getElementById("tarifaInput").addEventListener("input", () => {
          const nuevaTarifa =
            parseFloat(document.getElementById("tarifaInput").value) || 0;
          const servicio = carrito.find(
            (p) => p.tipo === "Servicio" && p.descripcion === "Habitación"
          );
          if (servicio) {
            servicio.precio = nuevaTarifa;
            renderCarrito();
          }
        });
      }

      function closeAlquiler() {
        document.getElementById("modalAlquiler").classList.remove("show");
      }

      function limpiarModalReserva() {
        resGuestDocType.selectedIndex = 0;
        resGuestDocNum.value = "";
        resGuestApellido1.value = "";
        resGuestApellido2.value = "";
        resGuestNombres.value = "";
        resGuestFechaNac.value = "";
        resGuestGenero.selectedIndex = 0;
        resHoras.value = 12;
        resTarifa.value = 50;
        resObs.value = "";
        resRucField.value = "";
        resRucField.disabled = true;
        document.querySelector('input[name="resComp"][value="boleta"]').checked = true;
        actualizarResumenReserva();
      }

      function openReserva() {
        const modal = document.getElementById("modalReserva");
        modal.classList.add("show");

        // Fecha y hora actual
        const ahora = new Date();
        const yyyy = ahora.getFullYear();
        const mm = String(ahora.getMonth() + 1).padStart(2, "0");
        const dd = String(ahora.getDate()).padStart(2, "0");
        const hh = String(ahora.getHours()).padStart(2, "0");
        const mins = String(ahora.getMinutes()).padStart(2, "0");

        // Poner por defecto fecha y hora actuales
        document.getElementById("resFecha").value = `${yyyy}-${mm}-${dd}`;
        document.getElementById("resHora").value = `${hh}:${mins}`;

        // Configurar fecha mínima = hoy
        document.getElementById("resFecha").min = `${yyyy}-${mm}-${dd}`;

        // Configurar hora mínima = ahora si la fecha seleccionada es hoy
        const horaInput = document.getElementById("resHora");
        horaInput.min = `${hh}:${mins}`;

        document.getElementById("resFecha").addEventListener("change", () => {
          const sel = document.getElementById("resFecha").value;
          const hoyStr = `${yyyy}-${mm}-${dd}`;
          if (sel === hoyStr) {
            horaInput.min = `${hh}:${mins}`;
          } else {
            horaInput.min = "00:00";
          }
        });
      }

      function closeReserva() {
        document.getElementById("modalReserva").classList.remove("show");
      }

      // RUC habilitar/deshabilitar
      document.querySelectorAll("input[name='resComp']").forEach((radio) => {
        radio.addEventListener("change", () => {
          const rucField = document.getElementById("resRucField");
          if (radio.value === "factura" && radio.checked) {
            rucField.disabled = false;
            rucField.focus();
          } else {
            rucField.disabled = true;
            rucField.value = "";
          }
        });
      });

      function registrarReserva() {
        const nombre = (resGuestNombres.value.trim() + " " +
                        resGuestApellido1.value.trim() + " " +
                        resGuestApellido2.value.trim()).toUpperCase();
        const fecha = resFecha.value;
        const hora = resHora.value;
        const monto = parseFloat(resTarifa.value) || 0; // 👈 corregido, usar tarifa
        const obs = resObs.value.trim();
        const docTipo = resGuestDocType.value;
        const docNum = resGuestDocNum.value.trim();

        if (!nombre || !fecha || !hora) {
          alert("Complete los campos obligatorios");
          return;
        }

        const reserva = { nombre, fecha, hora, monto, obs, compSel: document.querySelector('input[name="resComp"]:checked').value, ruc: (resRucField.value || "").trim(), docTipo, docNum };

        // Guardar en array y en localStorage
        reservas.push(reserva);
        saveReservas();

        renderReservas();
        generarPDFReserva(reserva);
        closeReserva();
        limpiarModalReserva();
      }

      async function generarPDFReserva(data) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: "portrait",
          unit: "mm",
          format: [80, 200],
        });

        let y = 10;
        doc.setFont("courier", "normal");
        doc.setFontSize(9);

        // --- LOGO (igual que venta) ---
        try {
          const logoUrl =
            "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQFpxGfaWiSnip5zDzE--DzTvrsVt5PoPD44Q&s";
          const img = await fetch(logoUrl)
            .then((res) => res.blob())
            .then(
              (b) =>
                new Promise((resolve) => {
                  const reader = new FileReader();
                  reader.onload = () => resolve(reader.result);
                  reader.readAsDataURL(b);
                })
            );
          doc.addImage(img, "PNG", 25, y, 30, 30);
          y += 35;
        } catch (e) {
          doc.text("HOTEL CARIBBEAN", 40, y, { align: "center" });
          y += 6;
        }

        // --- Datos empresa ---
        doc.setFontSize(9);
        doc.text("RUC: 20502468767", 40, y, { align: "center" });
        y += 4;
        doc.text("INVERSIONES CARIBBEAN S.A.C.", 40, y, { align: "center" });
        y += 4;
        doc.text("Jr. C. A. Salaverry 3560", 40, y, { align: "center" });
        y += 4;
        doc.text("Los Olivos - Lima", 40, y, { align: "center" });
        y += 8;

        // --- Tipo comprobante ---
        doc.setFontSize(10);
        doc.setFont("courier", "bold");
        doc.text(
          data.compSel === "factura" ? "FACTURA RESERVA" : "BOLETA RESERVA",
          40,
          y,
          { align: "center" }
        );
        y += 8;
        doc.setFont("courier", "normal");

        // --- Datos cliente ---
        doc.setFontSize(9);
        doc.text("Fecha: " + new Date().toLocaleString(), 2, y);
        y += 5;
        doc.text("Cliente: " + data.nombre, 2, y);
        y += 5;
        doc.text(
          data.compSel === "factura"
            ? "RUC: " + (data.ruc || "")
            : (data.docTipo || "") + ": " + (data.docNum || ""),
          2,
          y
        );
        y += 6;

        // --- Datos de la reserva ---
        doc.text("Reserva: " + data.fecha + " " + data.hora, 2, y);
        y += 5;
        doc.text("Observaciones: " + (data.obs || "—"), 2, y);
        y += 8;

        // --- Tabla productos ---
        doc.setFont("courier", "bold");
        doc.text("DESC          CANT    P.UNIT      IMP", 2, y);
        y += 4;
        doc.setFont("courier", "normal");
        doc.line(2, y, 78, y);
        y += 4;

        // único ítem: Habitación
        const cantidad = 1;
        const tarifa = data.monto.toFixed(2);
        doc.text("Habitación", 2, y);
        doc.text(String(cantidad), 35, y, { align: "right" });
        doc.text(tarifa, 55, y, { align: "right" });
        doc.text(tarifa, 78, y, { align: "right" });
        y += 5;

        // --- Totales ---
        y += 2;
        doc.line(2, y, 78, y);
        y += 5;
        doc.setFont("courier", "bold");
        doc.text("TOTAL: S/ " + data.monto.toFixed(2), 78, y, { align: "right" });
        doc.setFont("courier", "normal");

        // --- Mensaje ---
        y += 10;
        doc.setFontSize(9);
        doc.text("¡Gracias por su preferencia!", 40, y, { align: "center" });

        // Descargar PDF
        doc.save(`${data.compSel}_RESERVA_${Date.now()}.pdf`);
      }

      function actualizarResumenReserva() {
        const tarifa = parseFloat(document.getElementById("resTarifa").value) || 0;

        // Tabla (P. Unit = tarifa, Importe = tarifa × 1)
        document.getElementById("resTarifaOut").textContent = tarifa.toFixed(2);
        document.getElementById("resImporteOut").textContent = tarifa.toFixed(2);
        document.getElementById("resTotalFinal").textContent = tarifa.toFixed(2);

        // Campo "Recibí"
        document.getElementById("resPagoField").value = tarifa.toFixed(2);
      }

      document.getElementById("resTarifa").addEventListener("input", actualizarResumenReserva);

      const RESERVAS_KEY = "hc_pms_reservas_v1";
      let reservas = loadReservas();

      function loadReservas() {
        const raw = localStorage.getItem(RESERVAS_KEY);
        if (raw) {
          try {
            return JSON.parse(raw);
          } catch (e) {
            console.warn("Error cargando reservas, reiniciando", e);
          }
        }
        return [];
      }

      function saveReservas() {
        localStorage.setItem(RESERVAS_KEY, JSON.stringify(reservas));
      }

      function renderReservas() {
        const panel = document.getElementById("panel-reservas");
        panel.innerHTML = "";
        reservas.forEach((res) => {
          const card = document.createElement("div");
          card.className = "reserva-card";
          card.innerHTML = `
            <div class="reserva-nombre">${res.nombre}</div>
            <div class="reserva-monto">S/ ${res.monto.toFixed(2)}</div>
            <div class="text-xs text-gray-500 flex items-center gap-2">
              <i class="fa-solid fa-clock"></i> ${res.fecha} ${res.hora}
            </div>
            <span class="reserva-detalle">${res.obs || "Detalle"}</span>
          `;
          panel.appendChild(card);
        });
      }

      // inicializar
      actualizarResumenReserva();

      // Escuchar cambios
      document.getElementById("resHoras").addEventListener("input", actualizarResumenReserva);
      document.getElementById("resTarifa").addEventListener("input", actualizarResumenReserva);

      function openCaja() {
        document.getElementById("modalCaja").classList.remove("hidden");
        document.getElementById("modalCaja").classList.add("flex");
      }
      function closeCaja() {
        document.getElementById("modalCaja").classList.add("hidden");
      }
      document.querySelectorAll(".caja-tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".caja-tab-btn")
            .forEach((b) => b.classList.remove("active"));
          document
            .querySelectorAll(".caja-tab-content")
            .forEach((c) => c.classList.add("hidden"));
          btn.classList.add("active");
          document
            .getElementById("tab-" + btn.dataset.tab)
            .classList.remove("hidden");
        });
      });

      function logout() {
        window.location.href = "login.html";
      }

      renderRooms();
      renderReservas();
      renderPedidosPanel();

    </script>
  </body>
</html>
